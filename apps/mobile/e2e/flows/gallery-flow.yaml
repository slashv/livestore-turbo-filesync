appId: com.livestore.todo
---
# Gallery E2E Test - Basic upload and display flow
# Tests: login, upload image, verify display, delete image

# Clear keychain (where expo-secure-store keeps auth tokens)
- clearKeychain

# Clear app state and stop the app
- launchApp:
    clearState: true
    stopApp: true

# Register a unique user for this test run to ensure clean state
- runScript: ../scripts/register-user.js

# Launch app fresh after registration
- launchApp

# Step 1: Login with the unique test user
- assertVisible: "Sign In"
- tapOn:
    id: "email-input"
- inputText: ${output.testUser.email}
- tapOn:
    id: "password-input"
- inputText: ${output.testUser.password}
- tapOn:
    id: "login-button"

# Dismiss iOS "Save Password" dialog if it appears
- runFlow:
    when:
      visible:
        text: ".*assword.*"
    commands:
      - tapOn:
          text: ".*ot Now.*"

# Step 2: Wait for gallery to load
- extendedWaitUntil:
    visible:
      id: "gallery"
    timeout: 15000

# Step 3: Verify empty state shows initially
- assertVisible:
    id: "empty-state"

# Step 4: Tap upload button
- tapOn:
    id: "upload-button"

# Step 5: Handle permission dialog if it appears
- runFlow:
    when:
      visible:
        text: ".*Allow.*"
    commands:
      - tapOn:
          text: "Allow Full Access"

# Step 6: Select an image from the photo library
# Note: This interacts with the native iOS Photos picker
# In CI, you may need to seed photos or use a mock
- runFlow:
    when:
      visible:
        text: "Recents"
    commands:
      - tapOn:
          text: "Recents"

# Tap the first photo (if available)
- runFlow:
    when:
      visible:
        id: ".*Photo.*"
    commands:
      - tapOn:
          id: ".*Photo.*"
          index: 0
      # Wait for image to be added
      - extendedWaitUntil:
          visible:
            id: "image-card-.*"
          timeout: 30000

# Step 7: If we successfully added an image, verify it displays
- runFlow:
    when:
      visible:
        id: "image-card-.*"
    commands:
      # Verify empty state is hidden
      - assertNotVisible:
          id: "empty-state"
      # Verify image is displayed
      - assertVisible:
          id: "image-display-.*"
      # Wait for sync to complete
      - extendedWaitUntil:
          visible:
            id: "sync-status-synced"
          timeout: 60000
      # Delete the image for cleanup
      - tapOn:
          id: "delete-button-.*"
          index: 0
      # Verify image is removed
      - extendedWaitUntil:
          visible:
            id: "empty-state"
          timeout: 10000
